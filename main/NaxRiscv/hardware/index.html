

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Hardware &mdash; NaxRiscv  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/logo3_32x32.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/skins/default.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/wavedrom.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Misc" href="../misc/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> NaxRiscv
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#naxriscv">NaxRiscv</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#project-development-and-status">Project development and status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#why-a-ooo-core-targeting-fpga">Why a OoO core targeting FPGA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#additional-resources">Additional resources</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#pipeline">Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#how-to-use">How to use</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#hardware-description">Hardware description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acknowledgment">Acknowledgment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#funding">Funding</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../frontend/index.html">Frontend</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#decoder">Decoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#physical-register-allocation">Physical register allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#architectural-to-physical">Architectural to physical</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#physical-to-rob-id">Physical to ROB ID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#dispatch-issue">Dispatch / Issue</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../execution_units/index.html">Execution units</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../execution_units/index.html#custom-instruction">Custom instruction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../execution_units/index.html#simd-add">SIMD add</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#plugin-implementation">Plugin implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#naxriscv-generation">NaxRiscv generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#software-test">Software test</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#simulation">Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#conclusion">Conclusion</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#hardcore-way">Hardcore way</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../memory/index.html">Memory system</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../memory/index.html#load-store-unite">Load store unite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory/index.html#mmu">MMU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory/index.html#coherency">Coherency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory/index.html#l2-cache">L2 cache</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../branch_prediction/index.html">Branch prediction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../branch_prediction/index.html#fetch-prediction">Fetch prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch_prediction/index.html#decode-prediction">Decode prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch_prediction/index.html#jump-branch-circular-buffer">Jump/branch circular buffer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../backend/index.html">Backend</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../backend/index.html#commit">Commit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backend/index.html#register-file">Register file</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../backend/index.html#dual-port-based">Dual-port based</a></li>
<li class="toctree-l3"><a class="reference internal" href="../backend/index.html#latch-based">Latch based</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../simulation/index.html">Simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../simulation/index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../simulation/index.html#spike">Spike</a></li>
<li class="toctree-l2"><a class="reference internal" href="../simulation/index.html#multi-core-simulation">Multi core simulation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance and Area</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html#rv32">RV32</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html#rv64">RV64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html#notes">Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html#how-to-run-the-benchmark">How to run the benchmark</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../abstraction/index.html">Abstractions / HDL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../abstraction/index.html#framework">Framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../abstraction/index.html#plugin-tasks">Plugin tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../abstraction/index.html#service-definition">Service definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../abstraction/index.html#service-implementation">Service implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../abstraction/index.html#service-usage">Service usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../abstraction/index.html#service-pipeline-definition">Service Pipeline definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../abstraction/index.html#service-pipeline-usage">Service Pipeline usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../abstraction/index.html#execution-units">Execution units</a></li>
<li class="toctree-l3"><a class="reference internal" href="../abstraction/index.html#shiftplugin">ShiftPlugin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../abstraction/index.html#pipeline">Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../abstraction/index.html#state-machine-api">State machine API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../abstraction/index.html#automated-multiport-memory-transformation">Automated multiport memory transformation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../misc/index.html">Misc</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../misc/index.html#jtag-openocd-gdb">Jtag / OpenOCD / GDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/index.html#security">Security</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../misc/index.html#side-channel-attack">Side channel attack</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../misc/index.html#how-to-reproduce">How to reproduce</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#litex">Litex</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#digilent-nexys-video">Digilent nexys video</a></li>
<li class="toctree-l3"><a class="reference internal" href="#putting-debian-on-the-sdcard">Putting debian on the SDCARD</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-everything-from-scratch">Generating everything from scratch</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#asic">ASIC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#generating-verilog">Generating verilog</a></li>
<li class="toctree-l3"><a class="reference internal" href="#openram">OpenRam</a></li>
<li class="toctree-l3"><a class="reference internal" href="#openlane">OpenLane</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setup-how-to-reproduce">Setup / how to reproduce</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-simulation">Running simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#results">Results</a></li>
<li class="toctree-l4"><a class="reference internal" href="#issues">Issues</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NaxRiscv</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Hardware</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/NaxRiscv/hardware/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hardware">
<h1>Hardware<a class="headerlink" href="#hardware" title="Permalink to this heading">¶</a></h1>
<div class="section" id="litex">
<h2>Litex<a class="headerlink" href="#litex" title="Permalink to this heading">¶</a></h2>
<p>NaxRiscv is ported on Litex :</p>
<div class="section" id="digilent-nexys-video">
<h3>Digilent nexys video<a class="headerlink" href="#digilent-nexys-video" title="Permalink to this heading">¶</a></h3>
<p>Once Litex is installed, you can generate and load the Digilent nexys video bitstream via for instance :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># RV64IMAFDCSU config, enough to run linux</span>
python3<span class="w"> </span>-m<span class="w"> </span>litex_boards.targets.digilent_nexys_video<span class="w"> </span>--cpu-type<span class="o">=</span>naxriscv<span class="w">  </span>--bus-standard<span class="w"> </span>axi-lite<span class="w"> </span>--with-video-framebuffer<span class="w"> </span>--with-spi-sdcard<span class="w"> </span>--with-ethernet<span class="w"> </span>--xlen<span class="o">=</span><span class="m">64</span><span class="w"> </span>--scala-args<span class="o">=</span><span class="s1">&#39;rvc=true,rvf=true,rvd=true&#39;</span><span class="w"> </span>--build<span class="w"> </span>--load
</pre></div>
</div>
</div>
<div class="section" id="putting-debian-on-the-sdcard">
<h3>Putting debian on the SDCARD<a class="headerlink" href="#putting-debian-on-the-sdcard" title="Permalink to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">SDCARD</span><span class="o">=</span>/dev/???
<span class="o">(</span>
<span class="nb">echo</span><span class="w"> </span>o
<span class="nb">echo</span><span class="w"> </span>n
<span class="nb">echo</span><span class="w"> </span>p
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span>
<span class="nb">echo</span>
<span class="nb">echo</span><span class="w"> </span>+500M
<span class="nb">echo</span><span class="w"> </span>y
<span class="nb">echo</span><span class="w"> </span>n
<span class="nb">echo</span><span class="w"> </span>p
<span class="nb">echo</span><span class="w"> </span><span class="m">2</span>
<span class="nb">echo</span>
<span class="nb">echo</span><span class="w"> </span>+7G
<span class="nb">echo</span><span class="w"> </span>y
<span class="nb">echo</span><span class="w"> </span>t
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span>
<span class="nb">echo</span><span class="w"> </span>b
<span class="nb">echo</span><span class="w"> </span>p
<span class="nb">echo</span><span class="w"> </span>w
<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>fdisk<span class="w"> </span><span class="nv">$SDCARD</span>

sudo<span class="w"> </span>mkdosfs<span class="w"> </span><span class="si">${</span><span class="nv">SDCARD</span><span class="si">}</span><span class="m">1</span>
sudo<span class="w"> </span>mkfs<span class="w"> </span>-t<span class="w"> </span>ext2<span class="w"> </span><span class="si">${</span><span class="nv">SDCARD</span><span class="si">}</span><span class="m">2</span>
</pre></div>
</div>
<p>You need now to download part1 and part2 from <a class="reference external" href="https://drive.google.com/drive/folders/1OWY_NtJYWXd3oT8A3Zujef4eJwZFP_Yh?usp=sharing">https://drive.google.com/drive/folders/1OWY_NtJYWXd3oT8A3Zujef4eJwZFP_Yh?usp=sharing</a>
and extract them to ${SDCARD}1 and ${SDCARD}2</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download images from https://drive.google.com/drive/folders/1OWY_NtJYWXd3oT8A3Zujef4eJwZFP_Yh?usp=sharing</span>
mkdir<span class="w"> </span>mnt

sudo<span class="w"> </span>mount<span class="w"> </span><span class="si">${</span><span class="nv">SDCARD</span><span class="si">}</span><span class="m">1</span><span class="w"> </span>mnt
sudo<span class="w"> </span>tar<span class="w"> </span>-xf<span class="w"> </span>part1.tar.gz<span class="w"> </span>-C<span class="w"> </span>mnt
sudo<span class="w"> </span>umount<span class="w"> </span>mnt

sudo<span class="w"> </span>mount<span class="w"> </span><span class="si">${</span><span class="nv">SDCARD</span><span class="si">}</span><span class="m">2</span><span class="w"> </span>mnt
sudo<span class="w"> </span>tar<span class="w"> </span>-xf<span class="w"> </span>part2.tar.gz<span class="w"> </span>-C<span class="w"> </span>mnt
sudo<span class="w"> </span>umount<span class="w"> </span>mnt
</pre></div>
</div>
<p>Note that the DTB was generated for the digilent nexys video with :
python3 -m litex_boards.targets.digilent_nexys_video –cpu-type=naxriscv  –with-video-framebuffer –with-spi-sdcard –with-ethernet –xlen=64 –scala-args=’rvc=true,rvf=true,rvd=true’ –build –load</p>
<p>Then all should be good. You can login with user “root” password “root”. You can also connect via SSH to root.</p>
<p>The bottleneck of the system is by far accessing the spi-sdcard. (500 KB/s read speed), so, things take time the first time you run them. Then it is much faster (linux cached stuff). So, instead of –with-spi-sdcard, consider using –with-coherent-dma –with-sdcard with the driver patch described in <a class="reference external" href="https://github.com/SpinalHDL/NaxSoftware/tree/main/debian_litex">https://github.com/SpinalHDL/NaxSoftware/tree/main/debian_litex</a>, this will allow the SoC to reach 4MB/s on the sdcard.</p>
<p>The Debian chroot (part2) was generated by following <a class="reference external" href="https://wiki.debian.org/RISC-V#Creating_a_riscv64_chroot">https://wiki.debian.org/RISC-V#Creating_a_riscv64_chroot</a> and <a class="reference external" href="https://github.com/tongchen126/Boot-Debian-On-Litex-Rocket/blob/main/README.md#step3-build-debian-rootfs">https://github.com/tongchen126/Boot-Debian-On-Litex-Rocket/blob/main/README.md#step3-build-debian-rootfs</a>.
Also, it was generated inside QEMU, using <a class="reference external" href="https://github.com/esmil/riscv-linux">https://github.com/esmil/riscv-linux</a> “make sid”</p>
<p>You can also find the dts and linux .config on the google drive link. The .config came mostly from <a class="reference external" href="https://github.com/esmil/riscv-linux#kernel">https://github.com/esmil/riscv-linux#kernel</a> with a few additions, especialy, adding the litex drivers. The kernel was <a class="reference external" href="https://github.com/litex-hub/linux">https://github.com/litex-hub/linux</a> commit 53b46d10f9a438a29c061cac05fb250568d1d21b.</p>
<p>Adding packages, like xfce-desktop, chocolate-doom, openttd, visualboyadvance you can get things as following :</p>
<img alt="../../_images/debian_demo1.png" src="../../_images/debian_demo1.png" />
</div>
<div class="section" id="generating-everything-from-scratch">
<h3>Generating everything from scratch<a class="headerlink" href="#generating-everything-from-scratch" title="Permalink to this heading">¶</a></h3>
<p>You can find some documentation about how to generate :</p>
<ul class="simple">
<li><p>Debian rootfs</p></li>
<li><p>Linux kernel</p></li>
<li><p>OpenSBI</p></li>
</ul>
<p>here : <a class="reference external" href="https://github.com/SpinalHDL/NaxSoftware/tree/main/debian_litex">https://github.com/SpinalHDL/NaxSoftware/tree/main/debian_litex</a></p>
<p>It also contains some tips / tricks for the none Debian / Linux experts.</p>
</div>
</div>
<div class="section" id="asic">
<h2>ASIC<a class="headerlink" href="#asic" title="Permalink to this heading">¶</a></h2>
<p>While mainly focused on FPGA, NaxRiscv also integrate some ASIC friendly implementations :</p>
<ul class="simple">
<li><p>Latch based register file</p></li>
<li><p>Automatic generation of the openram scripts</p></li>
<li><p>Automatic blackboxing of the memory blocks (via SpinalHDL)</p></li>
<li><p>Parametrable reset strategy (via SpinalHDL)</p></li>
<li><p>An optimized multiplier</p></li>
</ul>
<div class="section" id="generating-verilog">
<h3>Generating verilog<a class="headerlink" href="#generating-verilog" title="Permalink to this heading">¶</a></h3>
<p>You can generate an example of ASIC tunned NaxRiscv using :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span><span class="nv">$NAXRISCV</span>
sbt<span class="w"> </span><span class="s2">&quot;runMain naxriscv.platform.asic.NaxAsicGen&quot;</span>

ls<span class="w"> </span>nax.v
</pre></div>
</div>
<p>If you want to target sky130, with openram memories, you can do :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span><span class="nv">$NAXRISCV</span>
sbt<span class="w"> </span><span class="s2">&quot;runMain naxriscv.platform.asic.NaxAsicGen --sky130-ram&quot;</span>

ls<span class="w"> </span>nax.v<span class="w"> </span>sram/*
</pre></div>
</div>
<p>In order to artificialy reduce the register file, you can use the <cite>–regfile-fake-ratio=X</cite> argument, where X need to be a power of two, and will reduce the register file size by that ratio.</p>
<p>You can also generate a design without load/store unit by having the <cite>–no-lsu</cite> argument.</p>
<p>If you use NaxRiscv as a toplevel, You can generate the netlist with flip flop on the IO via the <cite>–io-ff</cite> argument in order to relax timings.</p>
<p>You can ask SpinalHDL to blackbox memories with combinatorial read using the <cite>–bb-comb-ram</cite> argument. This will also generate a comb_ram.log file which contains the list of all the blackbox used. The layout of the blacbox is :</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span>ram_${number of read ports}ar_${number of write ports}w_${words}x${width} ${name of replaced ram} (
  .clk           (clk                             ), //i

  .writes_0_en   (...                             ), //i
  .writes_0_addr (...                             ), //i
  .writes_0_data (...                             ), //i
  .writes_._en   (...                             ), //i
  .writes_._addr (...                             ), //i
  .writes_._data (...                             ), //i

  .reads_0_addr  (...                             ), //i
  .reads_0_data  (...                             ), //o
  .reads_._addr  (...                             ), //i
  .reads_._data  (...                             ), //o
);
</pre></div>
</div>
<p>You can customize how the blackboxing is done by modifying <a class="reference external" href="https://github.com/SpinalHDL/NaxRiscv/blob/488c3397880b4c215022aa42f533574fe4dd366a/src/main/scala/naxriscv/compatibility/MultiportRam.scala#L488">https://github.com/SpinalHDL/NaxRiscv/blob/488c3397880b4c215022aa42f533574fe4dd366a/src/main/scala/naxriscv/compatibility/MultiportRam.scala#L488</a></p>
</div>
<div class="section" id="openram">
<h3>OpenRam<a class="headerlink" href="#openram" title="Permalink to this heading">¶</a></h3>
<p>You can use OpenRam to generate the ram macros generated by the “–sky130-ram” argument.</p>
<p>Here is a few dependencies to install first :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/VLSIDA/OpenRAM/blob/stable/docs/source/index.md#openram-dependencies">https://github.com/VLSIDA/OpenRAM/blob/stable/docs/source/index.md#openram-dependencies</a></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/VLSIDA/OpenRAM.git
<span class="nb">cd</span><span class="w"> </span>OpenRam

./install_conda.sh
make<span class="w"> </span>pdk<span class="w"> </span><span class="c1"># The first time only</span>
make<span class="w"> </span>install<span class="w">  </span>The<span class="w"> </span>first<span class="w"> </span><span class="nb">time</span><span class="w"> </span>only
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt

mv<span class="w"> </span>technology/sky130/tech/tech.py<span class="w"> </span>technology/sky130/tech/tech.py_old
sed<span class="w"> </span><span class="s1">&#39;/Leakage power of 3-input nand in nW/a spice[&quot;nand4_leakage&quot;] = 1&#39;</span><span class="w"> </span>technology/sky130/tech/tech.py_old<span class="w"> </span>&gt;<span class="w"> </span>technology/sky130/tech/tech.py


<span class="nb">cd</span><span class="w"> </span>macros
cp<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$NAXRISCV</span>/sram/sky*<span class="w"> </span>sram_configs
cp<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$NAXRISCV</span>/sram/openram.sh<span class="w"> </span>.<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>openram.sh

<span class="c1"># Run the macro generationThis will take quite some time</span>
./openram.sh

ls<span class="w"> </span>sky130_sram_1r1w_*
</pre></div>
</div>
</div>
<div class="section" id="openlane">
<h3>OpenLane<a class="headerlink" href="#openlane" title="Permalink to this heading">¶</a></h3>
<p>You can use openlane to generate a GDS of NaxRiscv.</p>
<div class="section" id="setup-how-to-reproduce">
<h4>Setup / how to reproduce<a class="headerlink" href="#setup-how-to-reproduce" title="Permalink to this heading">¶</a></h4>
<p>You can get the openlane docker via :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://openlane.readthedocs.io/en/latest/getting_started/installation/installation_common_section.html">https://openlane.readthedocs.io/en/latest/getting_started/installation/installation_common_section.html</a></p></li>
</ul>
<p>Then :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate a NaxRiscv verilog (here without using the ram macro)</span>
<span class="o">(</span><span class="nb">cd</span><span class="w"> </span><span class="nv">$NAXRISCV</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sbt<span class="w"> </span><span class="s2">&quot;runMain naxriscv.platform.asic.NaxAsicGen&quot;</span><span class="o">)</span>

git<span class="w"> </span>clone<span class="w"> </span>https://github.com/The-OpenROAD-Project/OpenLane.git
<span class="nb">cd</span><span class="w"> </span>OpenLane
make<span class="w"> </span>mount
make<span class="w"> </span>pdk<span class="w"> </span><span class="c1"># the first time only</span>

<span class="c1"># Setup the design</span>
cp<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$NAXRISCV</span>/src/main/openlane/nax<span class="w"> </span>designs/nax
mkdir<span class="w"> </span>designs/nax/src
cp<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$NAXRISCV</span>/nax.v<span class="w"> </span>designs/nax/src/nax.v

<span class="c1"># You will find your design in  designs/nax/runs/$TAG</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">TAG</span><span class="o">=</span>run_1

<span class="c1"># This will run all the openlane flow, and will take hours</span>
./flow.tcl<span class="w"> </span>-design<span class="w"> </span>nax<span class="w"> </span>-overwrite<span class="w"> </span>-tag<span class="w"> </span><span class="nv">$TAG</span>

<span class="c1"># Run the openroad GUI to visualise the design</span>
python3<span class="w"> </span>gui.py<span class="w"> </span>--viewer<span class="w"> </span>openroad<span class="w"> </span>./designs/nax/runs/<span class="nv">$TAG</span>
</pre></div>
</div>
<p>If you want to reproduce with the ram macros, then :</p>
<ul class="simple">
<li><p>Generate the NaxRiscv verilog file with the <cite>–sky130-ram</cite> argument.</p></li>
<li><p>update the designs/nax/src/nax.v</p></li>
<li><p>Generate the ram macro using openram</p></li>
<li><p>Uncomment the ram macro related things in the OpenLane/designs/nax/config.tcl file and copy the macros files there.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span><span class="nv">$NAXRISCV</span>
sbt<span class="w"> </span><span class="s2">&quot;runMain naxriscv.platform.asic.NaxAsicGen --sky130-ram&quot;</span>
cp<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$NAXRISCV</span>/nax.v<span class="w"> </span><span class="nv">$OPENLANE</span>/designs/nax/src/nax.v

<span class="c1"># Do the things described in the OpenRam chapter of this doc to generate the ram macros</span>

mkdir<span class="w"> </span><span class="nv">$OPENLANE</span>/designs/nax/sram
cp<span class="w"> </span><span class="nv">$OPENRAM</span>/macros/sky130_sram_1r1w_*/sky130_sram_1r1w_*.*<span class="w"> </span><span class="nv">$OPENLANE</span>/designs/nax/sram
sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;1 i\/// sta-blackbox&#39;</span><span class="w"> </span><span class="nv">$OPENLANE</span>/designs/nax/sram/*.v
sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/max_transition       : 0.04/max_transition       : 0.75/g&#39;</span><span class="w"> </span><span class="nv">$OPENLANE</span>/designs/nax/sram/*.lib

<span class="c1"># Run flow.tcl</span>
</pre></div>
</div>
</div>
<div class="section" id="running-simulation">
<h4>Running simulation<a class="headerlink" href="#running-simulation" title="Permalink to this heading">¶</a></h4>
<p>You can run a simulation which use the NaxRiscv ASIC specific feature inside a little SoC by running :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sbt<span class="w"> </span><span class="s2">&quot;runMain naxriscv.platform.tilelinkdemo.SocSim --load-elf ext/NaxSoftware/baremetal/dhrystone/build/rv32ima/dhrystone.elf --no-rvls --iverilog --asic&quot;</span>
</pre></div>
</div>
<p>By using iverilog instead of verilator, its ensure that the Latch based register file is functional.</p>
</div>
<div class="section" id="results">
<h4>Results<a class="headerlink" href="#results" title="Permalink to this heading">¶</a></h4>
<p>Here is the result of openlane with the sky130 PDK and NaxRiscv as toplevel (–regfile-fake-ratio=8 –io-ff), so, without any memory blackbox and with a reduced I$ / D$ / branch predictor size as follow :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="nc">FetchCachePlugin</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">wayCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">cacheSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">memDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span>
<span class="k">case</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="nc">DataCachePlugin</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">wayCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">cacheSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">memDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span>
<span class="k">case</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="nc">BtbPlugin</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
<span class="k">case</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="nc">GSharePlugin</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">memBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
<span class="k">case</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="nc">Lsu2Plugin</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">hitPedictionEntries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span>
</pre></div>
</div>
<img alt="../../_images/asic_1.png" src="../../_images/asic_1.png" />
<p>The maximal frequency is around ~100 Mhz, with most of the critical path time budget being spent into a high fanout net (see issues section). The total area used by the design cells being 1.633 mm².</p>
</div>
<div class="section" id="issues">
<h4>Issues<a class="headerlink" href="#issues" title="Permalink to this heading">¶</a></h4>
<p>There is mostly two main issues :</p>
<ul class="simple">
<li><p>Sky130 + openroad has “sever” density/congestion issues with the register file (4R2W/latch/tristate). One workaround would be <a class="reference external" href="https://github.com/AUCOHL/DFFRAM">https://github.com/AUCOHL/DFFRAM</a>, but unfortunately, it doesn’t support configs behond 2R1W (issue <a class="reference external" href="https://github.com/AUCOHL/DFFRAM/issues/192">https://github.com/AUCOHL/DFFRAM/issues/192</a>).</p></li>
<li><p>There is also a macro insertion halo issue which makes the usage of openram macros impossible at the moment, where the power lines get too close to the macro, not giving enough room for the data pins to route. See <a class="reference external" href="https://github.com/The-OpenROAD-Project/OpenLane/issues/2030">https://github.com/The-OpenROAD-Project/OpenLane/issues/2030</a></p></li>
</ul>
<p>Otherwise, one performance issue observed seems to be the unbalenced insertion of buffer on high fanout logics. One instance happend for the MMU TLB lookup. I had the TLB setup as 6 ways of 32 entries each (a lot), meaning the virtual address was used to gatter information from 7360 TLB bits (2530 muxes to drive). In this scenario, the ASIC critical path was this TLB lookup, where most of the timing budget was spent on distributing the virtual address signal to those muxes. The main issue being it was done through 13 layers of various buffer gates with a typical fanout of 10, while a utopian balanced fanout would be able to reach 10^13 gates, while here it is only to drive 2530 muxes. See <a class="reference external" href="https://github.com/The-OpenROAD-Project/OpenLane/issues/2090">https://github.com/The-OpenROAD-Project/OpenLane/issues/2090</a> for more info.</p>
<p>Here you can see in pink the buffer chain path.</p>
<img alt="../../_images/asic_buf_1.png" src="../../_images/asic_buf_1.png" />
</div>
</div>
</div>
</div>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../misc/index.html" class="btn btn-neutral float-left" title="Misc" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Spaghetti god.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>