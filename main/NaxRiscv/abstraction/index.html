

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Abstractions / HDL &mdash; NaxRiscv  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/logo3_32x32.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/skins/default.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/wavedrom.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Misc" href="../misc/index.html" />
    <link rel="prev" title="Performance and Area" href="../performance/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> NaxRiscv
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#naxriscv">NaxRiscv</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#project-developpement-and-status">Project developpement and status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#why-a-ooo-core-targeting-fpga">Why a OoO core targeting FPGA</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#pipeline">Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#how-to-use">How to use</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#hardware-description">Hardware description</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../frontend/index.html">Frontend</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#decoder">Decoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#physical-register-allocation">Physical register allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#architectural-to-physical">Architectural to physical</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#physical-to-rob-id">Physical to ROB ID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frontend/index.html#dispatch-issue">Dispatch / Issue</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../execution_units/index.html">Execution units</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../execution_units/index.html#custom-instruction">Custom instruction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../execution_units/index.html#simd-add">SIMD add</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#plugin-implementation">Plugin implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#naxriscv-generation">NaxRiscv generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#software-test">Software test</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#simulation">Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#conclusion">Conclusion</a></li>
<li class="toctree-l4"><a class="reference internal" href="../execution_units/index.html#hardcore-way">Hardcore way</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../memory/index.html">Memory system</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../memory/index.html#load-store-unite">Load store unite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory/index.html#mmu">MMU</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../branch_prediction/index.html">Branch prediction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../branch_prediction/index.html#fetch-prediction">Fetch prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch_prediction/index.html#decode-prediction">Decode prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../branch_prediction/index.html#jump-branch-circular-buffer">Jump/branch circular buffer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../backend/index.html">Backend</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../backend/index.html#commit">Commit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backend/index.html#register-file">Register file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../simulation/index.html">Simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../simulation/index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../simulation/index.html#spike">Spike</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance and Area</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html#rv32">RV32</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html#rv64">RV64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html#notes">Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html#how-to-run-the-benchmark">How to run the benchmark</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Abstractions / HDL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#framework">Framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#plugin-tasks">Plugin tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service-definition">Service definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service-implementation">Service implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service-usage">Service usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service-pipeline-definition">Service Pipeline definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service-pipeline-usage">Service Pipeline usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#execution-units">Execution units</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shiftplugin">ShiftPlugin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pipeline">Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="#state-machine-api">State machine API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#automated-multiport-memory-transformation">Automated multiport memory transformation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../misc/index.html">Misc</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../misc/index.html#jtag-openocd-gdb">Jtag / OpenOCD / GDB</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NaxRiscv</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Abstractions / HDL</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/NaxRiscv/abstraction/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="abstractions-hdl">
<span id="abstraction-hdl"></span><h1>Abstractions / HDL<a class="headerlink" href="#abstractions-hdl" title="Permalink to this headline">¶</a></h1>
<p>The NaxRiscv implementation take advantage of quite a few paradagm’s advailable when using the SpinalHDL (A Scala hardware description library).</p>
<div class="section" id="framework">
<h2>Framework<a class="headerlink" href="#framework" title="Permalink to this headline">¶</a></h2>
<p>The toplevel of NaxRiscv is mostly a empty Component with a framework which can schedule a
list plugins. The framework itself does not create any hardware.</p>
<p>Here is the NaxRiscv toplevel</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">NaxRiscv</span><span class="p">(</span><span class="n">xlen</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">plugins</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Plugin</span><span class="p">])</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">NaxScope</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">xlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xlen</span><span class="p">)</span><span class="w"> </span><span class="c1">//Will come back on that line later</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">framework</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Framework</span><span class="p">(</span><span class="n">plugins</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>To give an overview of how much the design is split between plugins,
here is the list of them for one functional CPU :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">plugins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ArrayBuffer</span><span class="p">[</span><span class="nc">Plugin</span><span class="p">]()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DocPlugin</span><span class="p">()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">MmuPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">spec</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">MmuSpec</span><span class="p">.</span><span class="n">sv32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">ioRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ioRange</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">fetchRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchRange</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">//FETCH</span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">FetchPlugin</span><span class="p">()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PcPlugin</span><span class="p">(</span><span class="n">resetVector</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">FetchCachePlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">cacheSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">wayCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">injectionAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">fetchDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">memDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">reducedBankWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">hitsWithTranslationWays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">translationStorageParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MmuStorageParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">levels</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nc">MmuStorageLevel</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ways</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="nc">MmuStorageLevel</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ways</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">translationPortParameter</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">MmuPortParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">readAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">hitsAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ctrlAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rspAt</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">AlignerPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">decodeCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">inputAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">//FRONTEND</span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">FrontendPlugin</span><span class="p">()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DecompressorPlugin</span><span class="p">()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DecoderPlugin</span><span class="p">()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">RfTranslationPlugin</span><span class="p">()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">RfDependencyPlugin</span><span class="p">()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">RfAllocationPlugin</span><span class="p">(</span><span class="n">riscv</span><span class="p">.</span><span class="nc">IntRegFile</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DispatchPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">slotCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">//BRANCH PREDICTION</span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">BranchContextPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">branchCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">HistoryPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">historyFetchBypass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DecoderPredictionPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">flushOnBranch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c1">//TODO remove me (DEBUG)</span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">BtbPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">readAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">hitAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">jumpAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">GSharePlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">memBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">KiB</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">historyWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">readAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">//LOAD / STORE</span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">LsuPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">lqSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">sqSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">loadToCacheBypass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">lqToCachePipelined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">hitPedictionEntries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">translationStorageParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MmuStorageParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">levels</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nc">MmuStorageLevel</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ways</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="nc">MmuStorageLevel</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ways</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">loadTranslationParameter</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">MmuPortParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">readAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">hitsAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ctrlAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rspAt</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">storeTranslationParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MmuPortParameter</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">readAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">hitsAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ctrlAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">rspAt</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DataCachePlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">memDataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">cacheSize</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">wayCount</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">refillCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">writebackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">tagsReadAsync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">reducedBankWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">loadRefillCheckEarly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">//MISC</span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">RobPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">robSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">completionWithReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CommitPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">commitCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">ptrCommitRetimed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">RegFilePlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">riscv</span><span class="p">.</span><span class="nc">IntRegFile</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">physicalDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">bankCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CommitDebugFilterPlugin</span><span class="p">(</span><span class="nc">List</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">))</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CsrRamPlugin</span><span class="p">()</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PrivilegedPlugin</span><span class="p">(</span><span class="nc">PrivilegedConfig</span><span class="p">.</span><span class="n">full</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">withRdTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">withRdTime</span><span class="p">))</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PerformanceCounterPlugin</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">additionalCounterCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">bufferWidth</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">//EXECUTION UNITES</span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ExecutionUnitBase</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SrcPlugin</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">earlySrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">IntAluPlugin</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">aluStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ShiftPlugin</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">aluStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">BranchPlugin</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="p">)</span><span class="w"></span>

<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ExecutionUnitBase</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SrcPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">IntAluPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ShiftPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">BranchPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)</span><span class="w"></span>

<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ExecutionUnitBase</span><span class="p">(</span><span class="s">&quot;EU2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">writebackCountMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SrcPlugin</span><span class="p">(</span><span class="s">&quot;EU2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">earlySrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">MulPlugin</span><span class="p">(</span><span class="s">&quot;EU2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">writebackAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">staticLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DivPlugin</span><span class="p">(</span><span class="s">&quot;EU2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">writebackAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">LoadPlugin</span><span class="p">(</span><span class="s">&quot;EU2&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StorePlugin</span><span class="p">(</span><span class="s">&quot;EU2&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">EnvCallPlugin</span><span class="p">(</span><span class="s">&quot;EU2&quot;</span><span class="p">)(</span><span class="n">rescheduleAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CsrAccessPlugin</span><span class="p">(</span><span class="s">&quot;EU2&quot;</span><span class="p">)(</span><span class="w"></span>
<span class="w">  </span><span class="n">decodeAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">readAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">writeAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">writebackAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">staticLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Each of those plugins may :</p>
<ul class="simple">
<li><p>Implement services used by other plugins (ex : provide jump
interfaces, provide rescheduling interface, provide a pipeline
skeleton)</p></li>
<li><p>Use other plugins functionalities</p></li>
<li><p>Create hardware</p></li>
<li><p>Create early tasks (used to setup things between plugins)</p></li>
<li><p>Create late tasks (used in general to create the required hardware)</p></li>
</ul>
<div class="section" id="plugin-tasks">
<h3>Plugin tasks<a class="headerlink" href="#plugin-tasks" title="Permalink to this headline">¶</a></h3>
<p>Here is can instance of dummy plugin creating two tasks (setup / logic):</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DummyPlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">early</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//Here you can setup things with other plugins</span>
<span class="w">    </span><span class="c1">//This code will always run before any late tasks</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">late</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//Here you can (for instance) generate hardware</span>
<span class="w">    </span><span class="c1">//This code will always start after any early task</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Note that create early and create late will execute their code into a
new threads, which are scheduled by the Framework class.</p>
</div>
<div class="section" id="service-definition">
<h3>Service definition<a class="headerlink" href="#service-definition" title="Permalink to this headline">¶</a></h3>
<p>For instance, the JumpService, allowing other plugins to ask a hardware jump interface for later uses. such service can be defined as :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">//Software interface (elaboration time)</span>
<span class="k">trait</span><span class="w"> </span><span class="nc">JumpService</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Service</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">createJumpInterface</span><span class="p">(</span><span class="n">priority</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Flow</span><span class="p">[</span><span class="nc">JumpCmd</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//Hardware payload of the interface</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">JumpCmd</span><span class="p">(</span><span class="n">pcWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">pcWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="service-implementation">
<h3>Service implementation<a class="headerlink" href="#service-implementation" title="Permalink to this headline">¶</a></h3>
<p>Taking the previously shown JumpService, the PcPlugin could implement it the following way :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">JumpSpec</span><span class="p">(</span><span class="n">interface</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="nc">Flow</span><span class="p">[</span><span class="nc">JumpCmd</span><span class="p">],</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">PcPlugin</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Plugin</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">JumpService</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">jumpsSpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ArrayBuffer</span><span class="p">[</span><span class="nc">JumpSpec</span><span class="p">]()</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">createJumpInterface</span><span class="p">(</span><span class="n">priority</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Flow</span><span class="p">[</span><span class="nc">JumpCmd</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">JumpSpec</span><span class="p">(</span><span class="nc">Flow</span><span class="p">(</span><span class="nc">JumpCmd</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span><span class="w"> </span><span class="n">priority</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">jumpsSpec</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">spec</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="n">interface</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">late</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//Here, implement the PC logic and manage the jumpsSpec interfaces</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">sortedJumps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jumpsSpec</span><span class="p">.</span><span class="n">sortBy</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">priority</span><span class="p">)</span><span class="w"> </span><span class="c1">//Lower priority first</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">jump</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sortedJumps</span><span class="p">){</span><span class="w"></span>
<span class="w">              </span><span class="n">when</span><span class="p">(</span><span class="n">jump</span><span class="p">.</span><span class="n">interface</span><span class="p">.</span><span class="n">valid</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="n">pc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">jump</span><span class="p">.</span><span class="n">interface</span><span class="p">.</span><span class="n">pc</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="service-usage">
<h3>Service usage<a class="headerlink" href="#service-usage" title="Permalink to this headline">¶</a></h3>
<p>Then another plugin could then retrieve and use this service by :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AnotherPlugin</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">early</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getService</span><span class="p">[</span><span class="nc">JumpService</span><span class="p">].</span><span class="n">createJumpInterface</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">late</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">setup</span><span class="p">.</span><span class="n">jump</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">???</span><span class="w"></span>
<span class="w">    </span><span class="n">setup</span><span class="p">.</span><span class="n">jump</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">???</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="service-pipeline-definition">
<h3>Service Pipeline definition<a class="headerlink" href="#service-pipeline-definition" title="Permalink to this headline">¶</a></h3>
<p>Some plugins may even create pipeline skeleton which can then be
populated by other plugins. For instance :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FetchPlugin</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Plugin</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">LockedImpl</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">early</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Pipeline</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stagesCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">stages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Array</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">stagesCount</span><span class="p">)(</span><span class="n">newStage</span><span class="p">())</span><span class="w"></span>

<span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="nn">pipeline</span><span class="p">.</span><span class="nc">Connection</span><span class="p">.</span><span class="n">_</span>
<span class="w">    </span><span class="c1">//Connect every stage together</span>
<span class="w">    </span><span class="k">for</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">stages</span><span class="p">.</span><span class="n">dropRight</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">stages</span><span class="p">.</span><span class="n">tail</span><span class="p">).</span><span class="n">zipped</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="n">connect</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)(</span><span class="nc">M2S</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">late</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="n">await</span><span class="p">()</span><span class="w"> </span><span class="c1">//Allow other plugins to make this blocking until they specified everything they wanted in the pipeline stages.</span>
<span class="w">    </span><span class="n">pipeline</span><span class="p">.</span><span class="n">build</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="service-pipeline-usage">
<h3>Service Pipeline usage<a class="headerlink" href="#service-pipeline-usage" title="Permalink to this headline">¶</a></h3>
<p>For instance, the PcPlugin will want to introduce the PC value into the
fetch pipeline :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">PcPlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">AreaObject</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">FETCH_PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stageable</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w">  </span><span class="c1">//Define the concept of a FETCH_PC signal being usable through a pipeline</span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">PcPlugin</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Plugin</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="p">...{</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">early</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">getService</span><span class="p">[</span><span class="nc">FetchPlugin</span><span class="p">].</span><span class="n">retain</span><span class="p">()</span><span class="w"> </span><span class="c1">//We need to hold the FetchPlugin logic task until we create all the associated accesses</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">late</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getService</span><span class="p">[</span><span class="nc">FetchPlugin</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">firstStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch</span><span class="p">.</span><span class="n">pipeline</span><span class="p">.</span><span class="n">stages</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">firstStage</span><span class="p">(</span><span class="nc">PcPlugin</span><span class="p">.</span><span class="nc">FETCH_PC</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">???</span><span class="w">   </span><span class="c1">//Assign the FETCH_PC value in firstStage of the pipeline. Other plugins may access it down stream.</span>
<span class="w">    </span><span class="n">fetch</span><span class="p">.</span><span class="n">release</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="execution-units">
<h3>Execution units<a class="headerlink" href="#execution-units" title="Permalink to this headline">¶</a></h3>
<p>Another practical usage of those concept is made for the execution units. You can spawn a execution unit by creating a new ExecutionUnitBase with
a unique execution unit identifier :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ExecutionUnitBase</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then you can populate that execution unit by adding new
ExecutionUnitElementSimple with the same identifier :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SrcPlugin</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">IntAluPlugin</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ShiftPlugin</span><span class="p">(</span><span class="s">&quot;EU0&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Here is the example of a execution unit handeling :</p>
<ul class="simple">
<li><p>mul/div</p></li>
<li><p>jump/branches</p></li>
<li><p>load/store</p></li>
<li><p>CSR accesses</p></li>
<li><p>ebreak/ecall/mret/wfi</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ExecutionUnitBase</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">writebackCountMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SrcPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">MulPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">writebackAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">staticLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">DivPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">writebackAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">BranchPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">writebackAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">staticLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">LoadPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StorePlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CsrAccessPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)(</span><span class="w"></span>
<span class="w">  </span><span class="n">decodeAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">readAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">writeAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">writebackAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">staticLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">plugins</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">EnvCallPlugin</span><span class="p">(</span><span class="s">&quot;EU1&quot;</span><span class="p">)(</span><span class="n">rescheduleAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="shiftplugin">
<h3>ShiftPlugin<a class="headerlink" href="#shiftplugin" title="Permalink to this headline">¶</a></h3>
<p>Here is the ShiftPlugin as a example of ExecutionUnitElementSimple
plugin:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span><span class="w"> </span><span class="nc">ShiftPlugin</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">AreaObject</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">SIGNED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stageable</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">LEFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stageable</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">ShiftPlugin</span><span class="p">(</span><span class="n">euId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">staticLatency</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">aluStage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">ExecutionUnitElementSimple</span><span class="p">(</span><span class="n">euId</span><span class="p">,</span><span class="w"> </span><span class="n">staticLatency</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nc">ShiftPlugin</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">euWritebackAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aluStage</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">early</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Setup</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nc">SrcKeys</span><span class="p">.</span><span class="n">_</span>

<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="nc">Rvi</span><span class="p">.</span><span class="nc">SLL</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="nc">SRC1</span><span class="p">.</span><span class="nc">RF</span><span class="p">,</span><span class="w"> </span><span class="nc">SRC2</span><span class="p">.</span><span class="nc">RF</span><span class="p">),</span><span class="w"> </span><span class="nc">DecodeList</span><span class="p">(</span><span class="nc">LEFT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">True</span><span class="p">,</span><span class="w">  </span><span class="nc">SIGNED</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="nc">Rvi</span><span class="p">.</span><span class="nc">SRL</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="nc">SRC1</span><span class="p">.</span><span class="nc">RF</span><span class="p">,</span><span class="w"> </span><span class="nc">SRC2</span><span class="p">.</span><span class="nc">RF</span><span class="p">),</span><span class="w"> </span><span class="nc">DecodeList</span><span class="p">(</span><span class="nc">LEFT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">,</span><span class="w"> </span><span class="nc">SIGNED</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="nc">Rvi</span><span class="p">.</span><span class="nc">SRA</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="nc">SRC1</span><span class="p">.</span><span class="nc">RF</span><span class="p">,</span><span class="w"> </span><span class="nc">SRC2</span><span class="p">.</span><span class="nc">RF</span><span class="p">),</span><span class="w"> </span><span class="nc">DecodeList</span><span class="p">(</span><span class="nc">LEFT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">,</span><span class="w"> </span><span class="nc">SIGNED</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">True</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="nc">Rvi</span><span class="p">.</span><span class="nc">SLLI</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="nc">SRC1</span><span class="p">.</span><span class="nc">RF</span><span class="p">,</span><span class="w"> </span><span class="nc">SRC2</span><span class="p">.</span><span class="nc">I</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nc">DecodeList</span><span class="p">(</span><span class="nc">LEFT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">True</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nc">SIGNED</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="nc">Rvi</span><span class="p">.</span><span class="nc">SRLI</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="nc">SRC1</span><span class="p">.</span><span class="nc">RF</span><span class="p">,</span><span class="w"> </span><span class="nc">SRC2</span><span class="p">.</span><span class="nc">I</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nc">DecodeList</span><span class="p">(</span><span class="nc">LEFT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">,</span><span class="w"> </span><span class="nc">SIGNED</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="nc">Rvi</span><span class="p">.</span><span class="nc">SRAI</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="nc">SRC1</span><span class="p">.</span><span class="nc">RF</span><span class="p">,</span><span class="w"> </span><span class="nc">SRC2</span><span class="p">.</span><span class="nc">I</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nc">DecodeList</span><span class="p">(</span><span class="nc">LEFT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">False</span><span class="p">,</span><span class="w"> </span><span class="nc">SIGNED</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">True</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">late</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Logic</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ExecuteArea</span><span class="p">(</span><span class="n">aluStage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">import</span><span class="w"> </span><span class="nn">stage</span><span class="p">.</span><span class="n">_</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SrcStageables</span><span class="w"></span>

<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="nc">Global</span><span class="p">.</span><span class="nc">XLEN</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">amplitude</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="nc">SRC2</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">downto</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="n">asUInt</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">reversed</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">[</span><span class="nc">SInt</span><span class="p">](</span><span class="nc">LEFT</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="nc">SRC1</span><span class="p">.</span><span class="n">reversed</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="nc">SRC1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">shifted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nc">S</span><span class="p">((</span><span class="nc">SIGNED</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="nc">SRC1</span><span class="p">.</span><span class="n">msb</span><span class="p">)</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">reversed</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">amplitude</span><span class="p">).</span><span class="n">resize</span><span class="p">(</span><span class="nc">Global</span><span class="p">.</span><span class="nc">XLEN</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">patched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LEFT</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">shifted</span><span class="p">.</span><span class="n">reversed</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">shifted</span><span class="w"></span>

<span class="w">      </span><span class="n">wb</span><span class="p">.</span><span class="n">payload</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">patched</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pipeline">
<h2>Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this headline">¶</a></h2>
<p>To allow the definition of extendable/flexible pipelines, the Pipeline abstraction was put in place. This abstractions allow to define stages, arbitrations, connections and values connected through them.</p>
<p>Here is a simple example :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">new</span><span class="w"> </span><span class="nc">Pipeline</span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="kd">val</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newStage</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="kd">val</span><span class="w"> </span><span class="n">decoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newStage</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="kd">val</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newStage</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="kd">val</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newStage</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="kd">val</span><span class="w"> </span><span class="n">writeback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newStage</span><span class="p">()</span><span class="w"></span>

<span class="w">       </span><span class="n">connect</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span><span class="w"> </span><span class="n">decoded</span><span class="p">)(</span><span class="nc">M2S</span><span class="p">())</span><span class="w"></span>
<span class="w">       </span><span class="n">connect</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span><span class="w"> </span><span class="n">execute</span><span class="p">)(</span><span class="nc">M2S</span><span class="p">())</span><span class="w"></span>
<span class="w">       </span><span class="n">connect</span><span class="p">(</span><span class="n">execute</span><span class="p">,</span><span class="w"> </span><span class="n">memory</span><span class="p">)(</span><span class="nc">M2S</span><span class="p">())</span><span class="w"></span>
<span class="w">       </span><span class="n">connect</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="n">writeback</span><span class="p">)(</span><span class="nc">M2S</span><span class="p">())</span><span class="w"></span>

<span class="w">       </span><span class="kd">val</span><span class="w"> </span><span class="nc">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stageable</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="c1">//This isn&#39;t a hardware signal, but it is a &quot;key&quot; used to identify the concept of PC (program counter) in the whole pipeline.</span>
<span class="w">       </span><span class="n">fetch</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">xxx</span><span class="w">      </span><span class="c1">//Assign xxx to the fetch(PC) value</span>
<span class="w">       </span><span class="n">yyy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">writeback</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w">  </span><span class="c1">//Assign the writeback(PC) value to yyy</span>

<span class="w">       </span><span class="n">execute</span><span class="p">.</span><span class="n">haltWhen</span><span class="p">(</span><span class="n">execute</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">zzz</span><span class="p">)</span><span class="w"> </span><span class="c1">//Halt the pipeline at the execute stage when the eecute(PC) match zzz</span>

<span class="w">       </span><span class="n">build</span><span class="p">()</span><span class="w">  </span><span class="c1">//Generate all the required hardware. This will for instance pipeline the PC from the fetch stage to where it is needed (execute/writeback stage)</span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Based on that API, multiple plugins in the NaxRiscv CPU can compose / extends existing pipelines.
Also notes that some plugins maybe put in place as a squeleton pipeline for others plugin to work with. This was done for the FetchPlugin, FrontendPlugin and the ExecutionUnitBase.</p>
<p>This API, combined with the concurrent hardware elaboration of the plugins also allows to have the number of stages in the pipeline to be adjusted depending the plugins needs, as it is done for the ExecutionUnitBase plugin.</p>
<p>To be more concret, execution units plugins using a ExecutionUnitBase as pipeline squeleton only have to refer to a given stage number for it to be dynamicaly created (if it wasn’t already created before).</p>
<p>Another functionaly in the pipeline API is allows identifying pipeline elements with a secondary key. For instance, in the following example some logic which could be used to calculate the next PC of a branch in a pipelined way.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stageable</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="nc">COND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stageable</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="n">stageA</span><span class="p">(</span><span class="nc">COND</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">xxx</span><span class="w"></span>
<span class="n">stageA</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;WITHOUT_BRANCH&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">stageA</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="c1">//Using the string &quot;WITHOUT_BRANCH&quot; as a secondary key</span>
<span class="n">stageA</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;WITH_BRANCH&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">stageA</span><span class="p">(</span><span class="nc">PC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">stageB</span><span class="p">(</span><span class="nc">COND</span><span class="p">)){</span><span class="w"></span>
<span class="w">  </span><span class="n">stageB</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;NEXT&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">stageB</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;WITH_BRANCH&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">ohterwise</span><span class="w"> </span><span class="n">stageB</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;WITHOUT_BRANCH&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">stageB</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;NEXT&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">stageB</span><span class="p">(</span><span class="nc">PC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;WITHOUT_BRANCH&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>But more generaly, this seconday key is used to access a “dimention” for instance, the pipeline being used to decode two instruction at the time :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="nc">OPCODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stageable</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"></span>
<span class="k">for</span><span class="p">(</span><span class="n">decodeIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">decodeCount</span><span class="p">){</span><span class="w"></span>
<span class="w">   </span><span class="n">decodeStage</span><span class="p">(</span><span class="nc">OPCODE</span><span class="p">,</span><span class="w"> </span><span class="n">decodeIndex</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">xxx</span><span class="w">   </span><span class="c1">//Using the index of the decoding unit we are working on as a secondary key</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="state-machine-api">
<h2>State machine API<a class="headerlink" href="#state-machine-api" title="Permalink to this headline">¶</a></h2>
<p>Not something ground breaking, but in a few places, the SpinalHDL state machine API is used. Here is a short example of the API :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">StateMachine</span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">stateA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">EntryPoint</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">stateB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">stateC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">State</span><span class="w"></span>
<span class="w">   </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="n">stateA</span><span class="p">.</span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateB</span><span class="p">))</span><span class="w"></span>

<span class="w">   </span><span class="n">stateB</span><span class="p">.</span><span class="n">onEntry</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">stateB</span><span class="p">.</span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">         </span><span class="n">when</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">4</span><span class="p">){</span><span class="w"></span>
<span class="w">           </span><span class="n">goto</span><span class="p">(</span><span class="n">stateC</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">stateB</span><span class="p">.</span><span class="n">onExit</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="n">stateC</span><span class="p">.</span><span class="n">whenIsActive</span><span class="w"> </span><span class="p">(</span><span class="n">goto</span><span class="p">(</span><span class="n">stateA</span><span class="p">))</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="automated-multiport-memory-transformation">
<h2>Automated multiport memory transformation<a class="headerlink" href="#automated-multiport-memory-transformation" title="Permalink to this headline">¶</a></h2>
<p>In quite a few places in the design, there is memories which need multiple write ports. Such memories are most of the time not directly inferable by the FPGA synthesis tools.</p>
<p>Still the NaxRiscv scala code define them all over the place, and to fill this gap, a custom SpinalHDL transformation phase was added to symplify them into groups of simple dual port ram with xor based glue.</p>
<p>Here is how this transformation phase is added into the flow</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">spinalConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SpinalConfig</span><span class="p">()</span><span class="w"></span>
<span class="n">spinalConfig</span><span class="p">.</span><span class="n">addTransformationPhase</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MultiPortWritesSymplifier</span><span class="p">)</span><span class="w"></span>
<span class="n">spinalConfig</span><span class="p">.</span><span class="n">generateVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">NaxRiscv</span><span class="p">(</span><span class="n">xlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">plugins</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>And here is how such transformation phase is defined :</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MultiPortWritesSymplifier</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">PhaseMemBlackboxing</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">doBlackboxing</span><span class="p">(</span><span class="n">pc</span><span class="p">:</span><span class="w"> </span><span class="nc">PhaseContext</span><span class="p">,</span><span class="w"> </span><span class="n">typo</span><span class="p">:</span><span class="w"> </span><span class="nc">MemTopology</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">typo</span><span class="p">.</span><span class="n">writes</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">typo</span><span class="p">.</span><span class="n">readsSync</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w"></span>
<span class="w">          </span><span class="n">typo</span><span class="p">.</span><span class="n">writes</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">w</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">mask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">typo</span><span class="p">.</span><span class="n">writes</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">w</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">clockDomain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">typo</span><span class="p">.</span><span class="n">writes</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">clockDomain</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typo</span><span class="p">.</span><span class="n">writes</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">clockDomain</span><span class="w"></span>

<span class="w">          </span><span class="k">import</span><span class="w"> </span><span class="nn">typo</span><span class="p">.</span><span class="n">_</span>

<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">parentScope</span><span class="p">.</span><span class="n">push</span><span class="p">(),</span><span class="w"> </span><span class="n">cd</span><span class="p">.</span><span class="n">push</span><span class="p">())</span><span class="w"></span>

<span class="w">          </span><span class="c1">// RamAsyncMwXor implement multiple write ports using simple dual port rams and xors</span>
<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RamAsyncMwXor</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">payloadType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">depth</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">wordCount</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">writePorts</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">writes</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">readPorts</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">readsAsync</span><span class="p">.</span><span class="n">size</span><span class="w"></span>
<span class="w">          </span><span class="p">).</span><span class="n">setCompositeName</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span><span class="w"></span>

<span class="w">          </span><span class="c1">//Connect the write ports to the RamAsyncMwXor</span>
<span class="w">          </span><span class="k">for</span><span class="p">((</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">writes</span><span class="p">,</span><span class="w"> </span><span class="n">writes</span><span class="p">).</span><span class="n">zipped</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="n">dst</span><span class="p">.</span><span class="n">valid</span><span class="p">.</span><span class="n">assignFrom</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">writeEnable</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">dst</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">assignFrom</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">dst</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">assignFrom</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="c1">//Connect the read ports to the RamAsyncMwXor</span>
<span class="w">          </span><span class="k">for</span><span class="p">((</span><span class="n">reworked</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">read</span><span class="p">,</span><span class="w"> </span><span class="n">readsAsync</span><span class="p">).</span><span class="n">zipped</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="n">reworked</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">assignFrom</span><span class="p">(</span><span class="n">old</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">wrapConsumers</span><span class="p">(</span><span class="n">typo</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">reworked</span><span class="p">.</span><span class="n">rsp</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">//Cleanup the old memory from the netlist</span>
<span class="w">          </span><span class="n">mem</span><span class="p">.</span><span class="n">removeStatement</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">mem</span><span class="p">.</span><span class="n">foreachStatements</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">removeStatement</span><span class="p">())</span><span class="w"></span>

<span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">restore</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../misc/index.html" class="btn btn-neutral float-right" title="Misc" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../performance/index.html" class="btn btn-neutral float-left" title="Performance and Area" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Spaghetti god.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>